# **SQLD Day 19 – 서브쿼리 ① (스칼라 · 중첩 · 상관 서브쿼리) (2025-10-31)**

> 📘 SQLD 2과목 | SQL 기본 및 응용  
> 🧑‍💻 학습자: Jaerok Kim (Raprok612)

---

## 🎯 학습 목표
- 스칼라(Single-Row), 중첩(Nested), 상관(Correlated) 서브쿼리의 차이 학습  
- 서브쿼리 실행 순서 이해  
- WHERE / SELECT / FROM 절에서의 서브쿼리 역할 파악  
- SQLD 기출에서 가장 자주 나오는 서브쿼리 패턴 숙지  

---

## 🧠 이론 정리

### 1️⃣ 서브쿼리의 위치별 의미

| 위치 | 설명 | 예시 |
|------|------|------|
| **WHERE 절** | 비교 조건을 위한 값 제공 | 단일행·다중행 서브쿼리 |
| **SELECT 절** | 계산 결과를 컬럼처럼 표현 | 스칼라 서브쿼리 |
| **FROM 절** | 인라인뷰 생성 | Top-N, 그룹 필터링 |

---

### 2️⃣ 단일행 vs 다중행 서브쿼리

#### ✔ 단일행 서브쿼리  
결과가 1행 → `=`, `<`, `>`, `<=`, `>=`, `<>`
```sql
SELECT ename, sal
FROM emp
WHERE sal > (SELECT AVG(sal) FROM emp);
```

#### ✔ 다중행 서브쿼리  
결과가 여러 행 → `IN`, `ANY`, `ALL`
```sql
SELECT ename, sal
FROM emp
WHERE sal IN (SELECT MAX(sal) FROM emp GROUP BY deptno);
```

---

### 3️⃣ 상관 서브쿼리 (Correlated Subquery)

외부 행을 참조하면서 **행마다 서브쿼리 재실행**

```sql
SELECT e1.ename, e1.sal
FROM emp e1
WHERE e1.sal = (
    SELECT MAX(e2.sal)
    FROM emp e2
    WHERE e2.deptno = e1.deptno
);
```

특징:
- 매 행마다 재평가 → 성능 주의  
- “부서별 최고급여”, “카테고리별 개수” 유형에 자주 등장  
- SQLD 기출에서도 빈출  

---

### 4️⃣ 스칼라 서브쿼리 (SELECT 절)

```sql
SELECT ename,
       (SELECT dname FROM dept WHERE deptno = e.deptno) AS dept_name
FROM emp e;
```

- SELECT 절에 위치  
- 반드시 **1행 1열만 반환**해야 함  

---

## 🧩 실전 패턴

### ✔ 패턴 1 — 평균 급여보다 높은 사원
```sql
SELECT ename, sal
FROM emp
WHERE sal > (SELECT AVG(sal) FROM emp);
```

### ✔ 패턴 2 — 부서 최고 급여 사원 찾기
```sql
SELECT ename, sal, deptno
FROM emp e
WHERE sal = (SELECT MAX(sal) 
             FROM emp 
             WHERE deptno = e.deptno);
```

### ✔ 패턴 3 — 다중행 + IN
```sql
SELECT ename, sal
FROM emp
WHERE sal IN (SELECT MAX(sal) FROM emp GROUP BY deptno);
```

### ✔ 패턴 4 — SELECT절 스칼라 서브쿼리
```sql
SELECT ename,
       (SELECT COUNT(*) FROM emp WHERE deptno = e.deptno) AS cnt
FROM emp e;
```

---

## ⚙️ 핵심 요약
- 서브쿼리는 “외부 쿼리 안에서 필요한 값/집계”를 먼저 구하는 구조  
- 단일행 vs 다중행 → 연산자(IN, ANY, ALL 등) 선택에 결정적  
- 상관 서브쿼리는 행마다 실행된다는 점을 반드시 기억  
- SELECT절 스칼라 서브쿼리는 1행 1열 필수  
- SQLD 기출에서 서브쿼리는 거의 매 회차 출제됨  

---

## 🧾 기출 복습

| 회차 | 문항 | 주제 | 비고 |
|------|------|--------|------|
| 기출 1회 | Q11–Q15 | 상관 서브쿼리 | WHERE절 조건 흐름 |
| 기출 2회 | Q21–Q25 | 단일행/다중행 구분 | 연산자 선택 주의 |
| 기출 3회 | Q26–Q30 | 인라인뷰 | ORDER BY 사용 시점 |

---

## 💬 느낀점
- 서브쿼리는 연산자 선택이 반 이상이었다.  
- 특히 상관 서브쿼리는 흐름을 도식화하면 훨씬 빨리 이해됐다.  
- 복잡한 문제도 결국 “단일행/다중행 판단 → 위치별 용도 구분”으로 해결 가능.  

---

## 🔗 참고자료
- 아이리포 SQLD 강의 – 2과목 19강  
- SQLD 공식 교재 2권 p.241~255  
