# **SQLD Day 14 – 단일행 서브쿼리 응용 (2025-10-26)**
> 📘 SQLD 2과목 | SQL 기본 및 응용  
> 🧑‍💻 학습자: Jaerok Kim (Raprok612)

---

## **🎯 학습 목표**
- 단일행 서브쿼리의 구조 및 특징 이해  
- 비교 연산자(=, >, <)를 활용한 단일행 서브쿼리 응용  
- SELECT, WHERE, HAVING 절 내 서브쿼리 실습

---

## **🧠 이론 정리**

### **1️⃣ 단일행 서브쿼리의 개념**
> 서브쿼리 결과가 **단 하나의 행(Row)과 열(Column)** 만 반환되는 경우를 단일행 서브쿼리라 한다.  
> 메인쿼리에서 단일 비교 연산자(`=, >, <, >=, <=, <>`)와 함께 사용된다.

```sql
SELECT ename, sal
FROM emp
WHERE sal > (SELECT AVG(sal) FROM emp);
```

| 특징 | 설명 |
|------|------|
| **결과값이 1건** | 한 행(Row)만 반환 |
| **단일 비교 연산자 사용** | `=`, `>`, `<`, `<>` 등 사용 가능 |
| **에러 발생 조건** | 서브쿼리가 2건 이상 반환 시 오류 발생 |

> 💡 단일행 서브쿼리는 주로 평균, 최대, 최소 등 **집계 결과 비교용**으로 사용된다.

---

### **2️⃣ 단일행 서브쿼리의 활용 위치**
| 위치 | 설명 | 예시 |
|------|------|------|
| **WHERE 절** | 조건 비교 | `WHERE sal > (SELECT AVG(sal) FROM emp)` |
| **HAVING 절** | 그룹 조건 비교 | `HAVING SUM(sal) > (SELECT AVG(sal) FROM emp)` |
| **SELECT 절** | 스칼라(Scalar) 서브쿼리 | `SELECT ename, (SELECT dname FROM dept WHERE deptno = e.deptno)` |

> ⚙️ SELECT 절 내 서브쿼리를 **스칼라 서브쿼리**라 하며, 메인쿼리의 각 행마다 1회씩 수행된다.

---

### **3️⃣ 단일행 서브쿼리 주의사항**
- 서브쿼리가 2건 이상 반환될 경우 **“ORA-01427: single-row subquery returns more than one row”** 오류 발생  
- 단일행 서브쿼리에서는 다중행 연산자(IN, ANY, ALL)을 사용할 수 없음  
- 단일행 결과임이 확실한 집계 함수(AVG, MAX, MIN 등)와 함께 사용하는 것이 안전함

---

## **⚙️ 모델링 유의사항**
1. 서브쿼리 결과가 단일행임을 보장해야 함  
2. SELECT 절의 스칼라 서브쿼리는 반복 수행으로 인한 성능 저하 가능성 주의  
3. 단일행 비교 연산 시 NULL 처리 방안(NVL, COALESCE) 고려  

---

## **⚙️ 핵심 요약**
- 단일행 서브쿼리는 한 건의 결과를 반환하며, 비교 연산자와 함께 사용된다.  
- SELECT, WHERE, HAVING 절 등 다양한 위치에서 활용 가능하다.  
- 스칼라 서브쿼리는 편리하지만 반복 실행되어 성능 저하 가능성이 있다.

---

## **🧮 예제 및 실습**
**예제 1️⃣ – 평균 급여보다 높은 사원 조회**
```sql
SELECT ename, sal
FROM emp
WHERE sal > (SELECT AVG(sal) FROM emp);
```

**예제 2️⃣ – 각 부서의 평균 급여보다 높은 사원 조회 (상관 서브쿼리)**  
```sql
SELECT e.ename, e.sal, e.deptno
FROM emp e
WHERE sal > (SELECT AVG(sal) FROM emp WHERE deptno = e.deptno);
```

- [x] 단일행 서브쿼리 비교 연산 실습  
- [x] SELECT 절 내 스칼라 서브쿼리 테스트  
- [ ] 상관 서브쿼리 성능 비교  

---

## **🧾 기출 복습**
| 회차 | 문항 | 주제 | 결과 | 비고 |
|------|------|------|------|------|
| 2023 2회 | Q66–Q70 | 단일행 서브쿼리 비교 연산 | ✅ | AVG, MAX, MIN 등 집계 함수 활용 |
| 2022 1회 | Q61–Q65 | 스칼라 서브쿼리 | ⚠ | SELECT 절 성능 이슈 확인 |

> 📘 **기출 출처:**  
> SQLD 공식 교재 2권 ‘SQL 기본 및 응용’ **기출예상문제 2-8절 (p.177~185)** 기반 정리

---

## **💬 느낀점 / 메모**
- 단일행 서브쿼리의 구조를 명확히 이해하니 오류 원인을 쉽게 파악할 수 있었다.  
- 스칼라 서브쿼리의 성능 이슈는 실제 쿼리 튜닝에서도 중요하다는 점을 배웠다.  
- 서브쿼리를 적절히 분리하면 SQL 가독성과 유지보수성이 높아진다.

---

## **🔗 참고자료**
- 아이리포 SQLD 강의 – 2과목 14강 (유튜브 14강): 단일행 서브쿼리 응용  
- SQLD 공식 교재 2권 p.129~144, p.177~185 (기출예상문제)  
- [단일행 서브쿼리와 스칼라 서브쿼리 – SQLGate 블로그](https://www.sqlgate.com/blog/sql-single-row-subquery)
